<!DOCTYPE html>
<html>

<head>
<title>设置优先级</title>
<link rel="stylesheet" href="/plugin/layui/css/layui.css" />
<script src="/plugin/jquery/jquery.js"></script>
<script src="/plugin/jquery/jquery.serializejson.js"></script>
<script src="/plugin/jsrender/jsrender.js"></script>
</head>

<body>
  <div class="layui-container" style="width:100%;">
    <button class="layui-btn layui-btn-normal" onclick="display()">
      <i class="layui-icon">&#x1002;</i>刷新
    </button>
    <form class="layui-form layui-form-pane" id="arrangementView" method="get">
      <div class="layui-form-item" style="display:none">
        <label class="layui-form-label">当前类型</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="type" id="currentType">
        </div>
      </div>
      <div class="layui-form-item" style="display:none">
        <label class="layui-form-label">当前课表ID</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="scheduleId" id="currentScheduleId">
        </div>
      </div>
      <div class="layui-form-item" style="display:none">
        <label class="layui-form-label">当前课时ID</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="periodId" id="currentPeriodId">
        </div>
      </div>
      <div class="layui-form-item" style="display:none">
        <label class="layui-form-label">当前课程ID</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="courseId" id="currentCourseId">
        </div>
      </div>
      <div class="layui-form-item" style="display:none">
        <label class="layui-form-label">当前教室ID</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="roomId" id="currentRoomId">
        </div>
      </div>
      <div class="layui-form-item" style="display:none">
        <label class="layui-form-label">当前班级ID</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="tclassId" id="currentTclassId">
        </div>
      </div>
      <div class="layui-form-item" style="display:none">
        <label class="layui-form-label">当前教师ID</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="teacherId" id="currentTeacherId">
        </div>
      </div>
      <div class="layui-form-item" pane>
        <label class="layui-form-label">优先级</label>
        <div class="layui-input-block">
          <input class="layui-input" type="radio" name="priority" lay-filter="priority" value="0" title="不">
          <input class="layui-input" type="radio" name="priority" lay-filter="priority" value="1" title="低">
          <input class="layui-input" type="radio" name="priority" lay-filter="priority" value="2" title="中">
          <input class="layui-input" type="radio" name="priority" lay-filter="priority" value="3" title="高">
          <input class="layui-input" type="radio" name="priority" lay-filter="priority" value="4" title="必">
        </div>
      </div>
    </form>
    <div class="layui-row" id="scheduleView"></div>
  </div>
  <script id="tmpl-scheduleView" type="text/x-jsrender">
	<div class="layui-col-md6">
      <blockquote class="layui-elem-quote">班级课表</blockquote>
      <div class="layui-form layui-form-pane">
        <div class="layui-form-item" pane>
          <label class="layui-form-label">课程</label>
          <div class="layui-input-block">
            {{for courseList tmpl="#tmpl-courseList" /}}
          </div>
        </div>
      </div>
      <div class="layui-col-md12">
        {{for tclassWeekViewList tmpl="#tmpl-tclassWeekView" /}}
      </div>
    </div>
    <div class="layui-col-md6">
      <blockquote class="layui-elem-quote">教师课表</blockquote>
      <div class="layui-form layui-form-pane">
        <div class="layui-form-item" pane>
          <label class="layui-form-label">班级/课程</label>
          <div class="layui-input-block">
            {{for tclassList tmpl="#tmpl-tclassList" /}}
            {{for courseList tmpl="#tmpl-specialList" /}}
          </div>
        </div>
      </div>
      <div class="layui-col-md12">
        {{for teacherWeekViewList tmpl="#tmpl-teacherWeekView" /}}
      </div>
    </div>
  </script>
  <script id="tmpl-courseList" type="text/x-jsrender">
    {{if type != 1}}
      <input type="radio" name="course" lay-filter="course" value="{{:courseId}}" title="{{:name}}">
    {{/if}}
  </script>
  <script id="tmpl-tclassList" type="text/x-jsrender">
    <input type="radio" name="tclass" lay-filter="tclass" value="{{:tclassId}}" title="{{:name}}">
  </script>
  <script id="tmpl-specialList" type="text/x-jsrender">
    {{if type == 1}}
      <input type="radio" name="special" lay-filter="special" value="{{:courseId}}" title="{{:name}}">
    {{/if}}
  </script>
  <script id="tmpl-tclassWeekView" type="text/x-jsrender">
    <div class="layui-col-md6">
      <table class="layui-table" lay-size="sm">
        <tbody>
          {{include titleView tmpl="#tmpl-tclassTitleView" /}}
          <tr>
            <th rowspan="2"></th>
            <th colspan="{{:#parent.parent.data.schedule.forenoon}}">上午</th>
            <th colspan="{{:#parent.parent.data.schedule.afternoon}}">下午</th>
          </tr>
          <tr>
            <th>早</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>
          </tr>
			{{for dayViewList tmpl="#tmpl-tclassDayView" /}}
        </tbody>
      </table>
      <table class="layui-table" lay-size="sm">
        <tr>
          {{for planViewList tmpl="#tmpl-tclassPlanView" /}}
        </tr>
      </table>
    </div>
    {{if (#getIndex() + 1) % 2 == 0}}</div><div class="layui-col-md12">{{/if}}
  </script>
  <script id="tmpl-teacherWeekView" type="text/x-jsrender">
    <div class="layui-col-md6">
      <table class="layui-table" lay-size="sm"">
        <tbody>
          {{include titleView tmpl="#tmpl-teacherTitleView" /}}
          <tr>
            <th rowspan="2"></th>
            <th colspan="{{:#parent.parent.data.schedule.forenoon}}">上午</th>
            <th colspan="{{:#parent.parent.data.schedule.afternoon}}">下午</th>
          </tr>
          <tr>
            <th>早</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>
          </tr>
			{{for dayViewList tmpl="#tmpl-teacherDayView" /}}
        </tbody>
      </table>
      <table class="layui-table" lay-size="sm">
        <tr>
          {{for planViewList tmpl="#tmpl-teacherPlanView" /}}
        </tr>
      </table>
    </div>
    {{if (#getIndex() + 1) % 2 == 0}}</div><div class="layui-col-md12">{{/if}}
  </script>
  <script id="tmpl-tclassTitleView" type="text/x-jsrender">
    <tr>
      <th colspan="3">{{:tclassName}}</th>
      <th colspan="3">{{:teacherName}}</th>
      <th colspan="3">{{:startDate}}</th>
    </tr>
  </script>
  <script id="tmpl-teacherTitleView" type="text/x-jsrender">
    <tr>
      <th colspan="3">{{:courseGradeName}}</th>
      <th colspan="3">{{:teacherName}}</th>
      <th colspan="3">{{:startDate}}</th>
    </tr>
  </script>
  <script id="tmpl-tclassDayView" type="text/x-jsrender">
    <tr>
      <td>{{:#getIndex() +1}}</td>
      {{for highestPeriodViewList tmpl="#tmpl-tclassPeriodView" /}}
    </tr>
  </script>
  <script id="tmpl-teacherDayView" type="text/x-jsrender">
    <tr>
      <td>{{:#getIndex() +1}}</td>
      {{for highestPeriodViewList tmpl="#tmpl-teacherPeriodView" /}}
    </tr>
  </script>
  <script id="tmpl-tclassPeriodView" type="text/x-jsrender">
    <td id="{{:periodViewId}}"
        style="cursor:pointer"
        onclick="clickTable({'type':'tclass',
							 'periodId':'{{:arrangement.period.periodId}}',
							 'tclassId':'{{:arrangement.tclass.tclassId}}',
							 'courseId':'{{:arrangement.course.courseId}}'})">
      {{if arrangement.course.shortName && arrangement.course.shortName.length > 1}}
        <span style="font-size:9px">{{:arrangement.course.shortName}}</span>
      {{else}}
          {{:arrangement.course.shortName}}
      {{/if}}</td>
  </script>
  <script id="tmpl-teacherPeriodView" type="text/x-jsrender">
	<td id="{{:periodViewId}}"
        style="cursor:pointer"
        onclick="clickTable({'type':'teacher',
							 'periodId':'{{:arrangement.period.periodId}}',
							 'courseId':'{{:arrangement.course.courseId}}',
							 'teacherId':'{{:arrangement.teacher.teacherId}}',
							 'tclassId':'{{:arrangement.tclass.tclassId}}'})">
      {{if arrangement.course.type != 1}}
        {{:arrangement.tclass.name}}
      {{else}}
        {{if arrangement.course.shortName && arrangement.course.shortName.length > 1}}
          <span style="font-size:9px">{{:arrangement.course.shortName}}</span>
        {{else}}
          {{:arrangement.course.shortName}}
        {{/if}}
      {{/if}}
    </td>
  </script>
  <script id="tmpl-tclassPlanView" type="text/x-jsrender">
    <td class="layui-col-md2">
      {{if plan.course.shortName.length > 1}}
        <span style="font-size:9px">{{:plan.course.shortName}}</span>
      {{else}}
        {{:plan.course.shortName}}
      {{/if}}
      {{:plan.periodNum-highestNum}}</td>
    {{if (#getIndex() + 1) % 6 == 0}}</tr><tr>{{/if}}
  </script>
  <script id="tmpl-teacherPlanView" type="text/x-jsrender">
    <td class="layui-col-md2">
      {{if plan.course.type != 01}}
        {{:plan.tclass.name}}
      {{else}}
        {{if plan.course.shortName.length > 1}}
          <span style="font-size:9px">{{:plan.course.shortName}}</span>
        {{else}}
          {{:plan.course.shortName}}
        {{/if}}
      {{/if}}
      {{:plan.periodNum-highestNum}}</td>
    {{if (#getIndex() + 1) % 6 == 0}}</tr><tr>{{/if}}
  </script>
  <script>
    var form = layui.form;
    var element = layui.element;
  
    $(document).ready(function() {
      var scheduleId = sessionStorage.getItem('currentScheduleId');
      $('#currentScheduleId').attr('value', scheduleId);
      display();
      $('#currentCourseId').attr('value', '0');
      $('#currentTclassId').attr('value', '0');
      $('#currentPriority').attr('value', '2');
      $('input:radio[name="priority"][value="2"]').prop('checked', true);
      form.render();
    });
      
    function display() {
      var scheduleId = sessionStorage.getItem('currentScheduleId');
      $.ajax({
        async : false,
        url : '/schedule/display/' + scheduleId,
        type : 'GET',
        success : function(scheduleView) {
          $('#scheduleView').html($.templates('#tmpl-scheduleView').render(scheduleView));
          $('th,td').css('font-size', '14px').css('padding', '2px 5px').css('text-align', 'center');
          form.on('radio(course)', function(course) {
            clearPriorityList();
            clearSpecialList();
            clearTclassList();
  
            $('#currentType').attr('value', 'tclass');
            $('#currentCourseId').attr('value', course.value);
            getPriorityList();
          });
          form.on('radio(tclass)', function(tclass) {
            clearPriorityList();
            clearCourseList();
            clearSpecialList();
  
            $('#currentType').attr('value', 'teacher');
            $('#currentTclassId').attr('value', tclass.value);
            getPriorityList();
          });
          form.on('radio(special)', function(course) {
            clearPriorityList();
            clearCourseList();
            clearTclassList();
  
            $('#currentType').attr('value', 'special');
            $('#currentCourseId').attr('value', course.value);
            getPriorityList();
          });
          form.render();
        }
      });
    }
  
    function clearPriorityList() {
      $('td[id]').each(function(index, elem) {
        td = $(elem);
        td.css('color', '#000000');
        td.css('background-color', '#FFFFFF');
      });
    }
  
    function clearCourseList() {
      $('input:radio[name="course"]').each(function(index, elem) {
        $(elem).prop('checked', false);
      });
      form.render();
      $('#currentCourseId').attr('value', '0');
    }
  
    function clearTclassList() {
      $('input:radio[name="tclass"]').each(function(index, elem) {
        $(elem).prop('checked', false);
      });
      form.render();
      $('#currentTclassId').attr('value', '0');
    }
  
    function clearSpecialList() {
      $('input:radio[name="special"]').each(function(index, elem) {
        $(elem).prop('checked', false);
      });
      form.render();
      $('#currentCourseId').attr('value', '0');
    }
  
    function clickTable(arrangement) {
      var clickedType = arrangement.type;
      var clickedPeriodId = arrangement.periodId;
      var clickedCourseId = arrangement.courseId;
      var clickedTclassId = arrangement.tclassId;
      var clickedTeacherId = arrangement.teacherId;
      var clickedRadio = getClickedRadio();
    
      $('#currentPeriodId').attr('value', clickedPeriodId);
      if (clickedType == 'tclass') {
        $('#currentTclassId').attr('value', clickedTclassId);
        if (clickedRadio == 'course') {
          $('#currentType').attr('value', 'tclass');
          setPriority();
          getPriorityList();
        }
      } else if (clickedType == 'teacher') {
        $('#currentTeacherId').attr('value', clickedTeacherId);
        if (clickedRadio == 'tclass') {
          $('#currentType').attr('value', 'teacher');
          $('#currentCourseId').attr('value', clickedCourseId);
          setPriority();
          getPriorityList();
        } else if (clickedRadio == 'special') {
          $('#currentType').attr('value', 'special');
          setPriority();
          getPriorityList();
        }
      }
    }
  
    function getClickedRadio() {
      var clickedType = '';
      $('input:radio[name!="priority"]').each(function(index, elem) {
        var radio = $(elem);
        if (radio.prop('checked') == true) {
          clickedType = radio.attr('name');
          return false;
        }
      });
      return clickedType;
    }
  
    function setPriority() {
      $.ajax({
        async : false,
        url : '/arrangement/setPriority',
        type : 'POST',
        dataType : 'json',
        contentType : 'application/json',
        data : JSON.stringify($('#arrangementView').serializeJSON()),
        success : function(result) {}
      });
    }
  
    function getPriorityList(scheduleId, type, typeId) {
      $.ajax({
        async : false,
        url : '/arrangement/getPriorityList',
        type : 'POST',
        dataType : 'json',
        contentType : 'application/json',
        data : JSON.stringify($('#arrangementView').serializeJSON()),
        success : function(priorityMap) {
          $.each(priorityMap, function(key, value) {
            var periodView = $('#' + key);
            switch (value) {
            case '0':
              periodView.css('background-color', '#DD3300');
              periodView.css('color', '#FFFFFF');
              break;
            case '1':
              periodView.css('background-color', '#FF9900');
              periodView.css('color', '#FFFFFF');
              break;
            case '2':
              periodView.css('background-color', '#FFFF00');
              periodView.css('color', '#000000');
              break;
            case '3':
              periodView.css('background-color', '#99EE00');
              periodView.css('color', '#FFFFFF');
              break;
            case '4':
              periodView.css('background-color', '#339900');
              periodView.css('color', '#FFFFFF');
              break;
            default:
              periodView.css('color', '#FFFFFF');
              break;
            }
          });
        }
      })
    }
  
    function isNull(obj) {
      return null == obj || '' == obj;
    }
  </script>
</body>

</html>
